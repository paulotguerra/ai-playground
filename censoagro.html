<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo Agropecuário 2025</title>
    
    <meta name="theme-color" content="#166534"/>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-body { padding-bottom: 100px; }
        .selectable-btn, .selectable-multi-btn {
            transition: all 0.2s ease-in-out;
        }
        .selectable-btn.active, .selectable-multi-btn.active {
            background-color: #16a34a;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .material-symbols-outlined {
            vertical-align: bottom;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div id="app" class="relative min-h-screen pb-40">

        <header class="bg-green-800 text-white shadow-lg p-4 flex justify-between items-center fixed top-0 left-0 right-0 z-20">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-3xl">eco</span>
                <h1 class="text-xl font-bold">Censo Agropecuário de Quixadá</h1>
            </div>
            <div id="menu-wrapper" class="relative">
                <button id="record-counter-btn" class="bg-green-600 hover:bg-green-500 text-white text-lg font-bold rounded-full h-10 w-10 flex items-center justify-center transition-colors">
                    <span id="record-counter-badge">0</span>
                </button>
                <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-30 text-gray-700">
                    <a href="#" id="delete-all-btn" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50"><span class="material-symbols-outlined">delete_sweep</span> Remover todos</a>
                    <a href="#" id="install-pwa-btn" class="hidden flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-100"><span class="material-symbols-outlined">download</span> Instalar App</a>
                    <a href="#" id="about-btn" class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-100"><span class="material-symbols-outlined">info</span> Sobre</a>
                </div>
            </div>
        </header>

        <main id="records-list-container" class="pt-20 px-4 pb-24"></main>

        <div id="empty-state" class="hidden pt-20 px-4 text-center text-gray-500">
            <div class="mt-16 flex flex-col items-center">
                <span class="material-symbols-outlined text-6xl mb-4">description</span>
                <h2 class="text-2xl font-semibold">Nenhum registro encontrado</h2>
                <p class="mt-2">Clique em "Novo" para adicionar o primeiro registro.</p>
            </div>
        </div>

        <footer class="fixed bottom-[1vh] left-0 right-0 flex justify-center items-center z-10 p-4 gap-4">
             <button id="export-csv-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 transition-transform transform hover:scale-105">
                <span class="material-symbols-outlined">csv</span>
                Exportar CSV
            </button>
            <button id="add-new-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 transition-transform transform hover:scale-105">
                <span class="material-symbols-outlined">add_circle</span>
                Novo
            </button>
        </footer>
    </div>

    <div id="form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col relative">
            <header class="p-4 border-b bg-gray-50 rounded-t-lg flex-shrink-0 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-green-800">Adicionar Novo Registro</h2>
                <button id="lgpd-info-btn" class="text-blue-600 hover:text-blue-800" title="Informações sobre a LGPD">
                    <span class="material-symbols-outlined text-3xl">info</span>
                </button>
            </header>
            
            <div class="overflow-y-auto p-6 modal-body">
                <form id="census-form">
                    <input type="hidden" id="record-id" name="record-id">

                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Identificação do produtor e estabelecimento</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2"><label for="nomeCompleto" class="block text-lg font-medium text-gray-700">Nome completo*</label><input type="text" id="nomeCompleto" name="nomeCompleto" required placeholder="Ex: João da Silva" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3"></div>
                            <div><label for="cpf" class="block text-lg font-medium text-gray-700">CPF</label><input type="text" id="cpf" name="cpf" inputmode="numeric" placeholder="111.222.333-44" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3"></div>
                            <div><label for="telefone" class="block text-lg font-medium text-gray-700">Telefone</label><input type="tel" id="telefone" name="telefone" inputmode="numeric" placeholder="(88) 91234-5678" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3"></div>
                            <div class="md:col-span-2"><label for="endereco" class="block text-lg font-medium text-gray-700">Endereço da propriedade</label><input type="text" id="endereco" name="endereco" placeholder="Ex: Sítio Cajueiro, Distrito de Juá" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3"></div>
                             <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                <div class="sm:col-span-2">
                                    <label class="block text-lg font-medium text-gray-700">Geolocalização</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" id="latitude" name="latitude" placeholder="Latitude" readonly class="block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm text-lg p-3">
                                        <input type="text" id="longitude" name="longitude" placeholder="Longitude" readonly class="block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm text-lg p-3">
                                    </div>
                                </div>
                                <button type="button" id="get-coords-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 text-lg"><span class="material-symbols-outlined">location_on</span> Obter coordenadas</button>
                            </div>
                            <div><label for="areaTotal" class="block text-lg font-medium text-gray-700">Área total (ha)</label><input type="number" id="areaTotal" name="areaTotal" step="0.1" placeholder="Ex: 50.5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3"></div>
                             <div><label for="areaProdutiva" class="block text-lg font-medium text-gray-700">Área produtiva (ha)</label><input type="number" id="areaProdutiva" name="areaProdutiva" step="0.1" placeholder="Ex: 25.5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3"></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Tipo de posse e documentação</h3>
                         <div class="md:col-span-2">
                            <label for="posseTerra" class="block text-lg font-medium text-gray-700">Tipo de posse da terra</label>
                            <select id="posseTerra" name="posseTerra" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg p-3">
                                <option>Própria</option><option>Arrendada</option><option>Cedida</option><option>Assentamento</option><option>Outro</option>
                            </select>
                            <input type="text" id="posseTerraOutro" name="posseTerraOutro" placeholder="Especificar qual" class="hidden mt-2 w-full border-gray-300 rounded-md shadow-sm text-lg p-3">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Culturas com área e irrigação</h3>
                        <div class="space-y-4">
                            <div class="p-4 border rounded-md"><label class="flex items-center text-lg"><input type="checkbox" name="atividadesAgricolas" value="Milho" data-details="detalhesMilho" class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">Milho</label><div id="detalhesMilho" class="hidden mt-3 pl-8 space-y-3"><input type="number" step="0.1" id="areaMilho" name="areaMilho" placeholder="Área cultivada (ha)" class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"><div class="flex flex-col gap-2"><span class="text-lg">Irrigado?</span><div class="selectable-buttons flex gap-2" data-target-input="irrigadoMilho"><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Sim">Sim</button><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Não">Não</button></div><input type="hidden" id="irrigadoMilho" name="irrigadoMilho"></div></div></div>
                            <div class="p-4 border rounded-md"><label class="flex items-center text-lg"><input type="checkbox" name="atividadesAgricolas" value="Feijão" data-details="detalhesFeijao" class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">Feijão</label><div id="detalhesFeijao" class="hidden mt-3 pl-8 space-y-3"><input type="number" step="0.1" id="areaFeijao" name="areaFeijao" placeholder="Área cultivada (ha)" class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"><div class="flex flex-col gap-2"><span class="text-lg">Irrigado?</span><div class="selectable-buttons flex gap-2" data-target-input="irrigadoFeijao"><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Sim">Sim</button><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Não">Não</button></div><input type="hidden" id="irrigadoFeijao" name="irrigadoFeijao"></div></div></div>
                            <div class="p-4 border rounded-md"><label class="flex items-center text-lg"><input type="checkbox" name="atividadesAgricolas" value="Mandioca" data-details="detalhesMandioca" class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">Mandioca</label><div id="detalhesMandioca" class="hidden mt-3 pl-8 space-y-3"><input type="number" step="0.1" id="areaMandioca" name="areaMandioca" placeholder="Área cultivada (ha)" class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"><div class="flex flex-col gap-2"><span class="text-lg">Irrigado?</span><div class="selectable-buttons flex gap-2" data-target-input="irrigadoMandioca"><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Sim">Sim</button><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Não">Não</button></div><input type="hidden" id="irrigadoMandioca" name="irrigadoMandioca"></div></div></div>
                            <div class="p-4 border rounded-md"><label class="flex items-center text-lg"><input type="checkbox" name="atividadesAgricolas" value="Hortaliças" data-details="detalhesHortalicas" class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">Hortaliças</label><div id="detalhesHortalicas" class="hidden mt-3 pl-8"><input type="text" id="especificarHortalicas" name="especificarHortalicas" placeholder="Ex: Alface, tomate, 0.5ha" class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div>
                            <div class="p-4 border rounded-md"><label class="flex items-center text-lg"><input type="checkbox" name="atividadesAgricolas" value="Fruticultura" data-details="detalhesFruticultura" class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">Fruticultura</label><div id="detalhesFruticultura" class="hidden mt-3 pl-8"><input type="text" id="especificarFruticultura" name="especificarFruticultura" placeholder="Ex: Manga, banana, 2ha" class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div>
                            <div class="p-4 border rounded-md"><label class="flex items-center text-lg"><input type="checkbox" name="atividadesAgricolas" value="Outro" data-details="detalhesOutro" class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">Outro</label><div id="detalhesOutro" class="hidden mt-3 pl-8"><input type="text" id="especificarOutro" name="especificarOutro" placeholder="Ex: Gergelim, 1.5ha" class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div>
                        </div>
                    </div>

                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Criação de animais com quantidade</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div><label for="bovinos" class="block text-lg font-medium text-gray-700">Bovinos</label><input type="number" id="bovinos" name="bovinos" placeholder="Qtd." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div><label for="caprinos" class="block text-lg font-medium text-gray-700">Caprinos</label><input type="number" id="caprinos" name="caprinos" placeholder="Qtd." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div><label for="ovinos" class="block text-lg font-medium text-gray-700">Ovinos</label><input type="number" id="ovinos" name="ovinos" placeholder="Qtd." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div><label for="suinos" class="block text-lg font-medium text-gray-700">Suínos</label><input type="number" id="suinos" name="suinos" placeholder="Qtd." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div class="col-span-2 md:col-span-4"><label for="outrasCriacoes" class="block text-lg font-medium text-gray-700">Outras criações</label><input type="text" id="outrasCriacoes" name="outrasCriacoes" placeholder="Ex: Galinhas, abelhas" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div></div>
                    
                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Atividades complementares</h3><div><label class="block text-lg font-medium text-gray-700">Outras atividades</label><div class="multi-selectable-buttons mt-2 flex flex-wrap gap-2" data-group-name="outrasAtividades"><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Agroindústria" data-triggers-details="true">Agroindústria</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Turismo Rural" data-triggers-details="true">Turismo Rural</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Apicultura">Apicultura</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Piscicultura">Piscicultura</button></div><input type="text" id="outrasAtividadesDetalhes" name="outrasAtividadesDetalhes" placeholder="Ex: Produção de queijo, Pousada" class="hidden mt-2 w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div>

                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Infraestrutura e equipamentos</h3><div class="space-y-4"><div><label class="block text-lg font-medium text-gray-700">Fonte de água</label><div class="multi-selectable-buttons mt-2 flex flex-wrap gap-2" data-group-name="fonteAgua"><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Poço">Poço</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Açude">Açude</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Cisterna">Cisterna</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Outro">Outro</button></div><input type="text" id="fonteAguaOutro" name="fonteAguaOutro" placeholder="Especificar qual" class="hidden mt-2 w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div><label class="block text-lg font-medium text-gray-700">Energia elétrica?</label><div class="selectable-buttons mt-2 flex gap-2" data-target-input="energiaEletrica"><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Sim">Sim</button><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Não">Não</button></div><input type="hidden" id="energiaEletrica" name="energiaEletrica"></div><div><label for="transporte" class="block text-lg font-medium text-gray-700">Transporte</label><input type="text" id="transporte" name="transporte" placeholder="Ex: Moto, carro, etc" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div><label class="block text-lg font-medium text-gray-700">Possui trator?</label><div class="selectable-buttons mt-2 flex gap-2" data-target-input="possuiTrator"><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Sim">Sim</button><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Não">Não</button></div><input type="hidden" id="possuiTrator" name="possuiTrator"></div><div><label for="outrosEquipamentos" class="block text-lg font-medium text-gray-700">Outros equipamentos/máquinas</label><input type="text" id="outrosEquipamentos" name="outrosEquipamentos" placeholder="Ex: Forrageira, roçadeira" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div></div>
                    
                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Número de trabalhadores</h3><div><label class="block text-lg font-medium text-gray-700 mb-2">Trabalhadores</label><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="flex flex-col"><label for="trabalhadoresFamiliares" class="text-md text-gray-600 mb-1">Familiares</label><input type="number" id="trabalhadoresFamiliares" name="trabalhadoresFamiliares" placeholder="Qtd." class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div class="flex flex-col"><label for="trabalhadoresTemporarios" class="text-md text-gray-600 mb-1">Temporários</label><input type="number" id="trabalhadoresTemporarios" name="trabalhadoresTemporarios" placeholder="Qtd." class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div class="flex flex-col"><label for="trabalhadoresPermanentes" class="text-md text-gray-600 mb-1">Permanentes</label><input type="number" id="trabalhadoresPermanentes" name="trabalhadoresPermanentes" placeholder="Qtd." class="w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div></div></div>

                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Destino, crédito e programas</h3><div class="space-y-4"><div><label class="block text-lg font-medium text-gray-700">Destino da produção</label><div class="multi-selectable-buttons mt-2 flex flex-wrap gap-2" data-group-name="destinoProducao"><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Consumo próprio">Consumo próprio</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Venda local">Venda local</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Feira">Feira</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Cooperativa">Cooperativa</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Outro">Outro</button></div><input type="text" id="destinoProducaoOutro" name="destinoProducaoOutro" placeholder="Especificar qual" class="hidden mt-2 w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div><div><label class="block text-lg font-medium text-gray-700">Acesso a crédito?</label><div class="selectable-buttons mt-2 flex gap-2" data-target-input="acessoCredito"><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Sim">Sim</button><button type="button" class="selectable-btn py-2 px-4 rounded-md bg-gray-200" data-value="Não">Não</button></div><input type="hidden" id="acessoCredito" name="acessoCredito"></div><div><label class="block text-lg font-medium text-gray-700">Programas governamentais</label><div class="multi-selectable-buttons mt-2 flex flex-wrap gap-2" data-group-name="programasGoverno"><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="PNAE">PNAE</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="PAA">PAA</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="PRONAF">PRONAF</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Outro">Outro</button></div><input type="text" id="programasGovernoOutro" name="programasGovernoOutro" placeholder="Especificar qual" class="hidden mt-2 w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div></div>

                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Principais desafios</h3><div><label class="block text-lg font-medium text-gray-700">Principais desafios</label><div class="multi-selectable-buttons mt-2 flex flex-wrap gap-2" data-group-name="desafios"><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Água">Água</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Infraestrutura">Infraestrutura</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Crédito">Crédito</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Mercado">Mercado</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Assistência técnica">Assistência técnica</button><button type="button" class="selectable-multi-btn py-2 px-4 rounded-md bg-gray-200" data-value="Outro">Outro</button></div><input type="text" id="desafiosOutro" name="desafiosOutro" placeholder="Especificar qual" class="hidden mt-2 w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></div></div>
                    
                    <div class="mb-6"><h3 class="text-xl font-semibold text-green-800 border-b pb-2 mb-4">Observações gerais</h3><div><label for="observacoes" class="block text-lg font-medium text-gray-700">Anotações livres</label><textarea id="observacoes" name="observacoes" rows="4" placeholder="Alguma observação importante..." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-lg p-3"></textarea></div></div>
                    
                    <div class="mb-16 mt-6 p-4 border-t">
                        <label class="flex items-center text-base">
                            <input type="checkbox" id="lgpdConfirm" name="lgpdConfirm" required class="h-6 w-6 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3">
                            <span class="text-gray-700">Declaro que o(a) entrevistado(a) foi esclarecido(a) sobre a natureza e o propósito da coleta de dados e que manifestou sua ciência e concordância, nos termos da Lei Geral de Proteção de Dados (Lei nº 13.709/2018).</span>
                        </label>
                    </div>
                </form>
            </div>
            
            <div class="absolute bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-sm border-t rounded-b-lg flex justify-end gap-4">
                <button id="cancel-btn" type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md">Cancelar</button>
                <button id="save-btn" type="submit" form="census-form" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">Salvar</button>
            </div>
        </div>
    </div>

    <div id="about-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg text-gray-700 relative">
            <button id="close-about-btn" class="absolute top-2 right-2 p-2 text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
            <h3 class="text-2xl font-bold mb-4 text-green-800">Sobre o Aplicativo</h3>
            <p class="mb-2">Este aplicativo foi projetado para a coleta de dado do Censo Agropecuário – Município de Quixadá (2025).</p>
            <p class="mb-4">Todos os dados são armazenados localmente no dispositivo.</p>
            <hr class="my-4">
            <p class="mb-2"><strong>Desenvolvido por:</strong><br><a href="https://www.quixada.ufc.br/" target="_blank" class="text-blue-600 hover:underline">UFC - Campus Quixadá</a></p>
            <p><strong>Licença:</strong><br>Este software é distribuído sob a <a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600 hover:underline">Licença MIT</a>.</p>
        </div>
    </div>
    
    <div id="lgpd-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative">
            <header class="p-4 border-b flex justify-between items-center">
                 <h3 class="text-2xl font-bold text-green-800">Termo de Esclarecimento sobre a LGPD</h3>
                 <button id="close-lgpd-btn" class="p-2 text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
            </header>
            <div class="p-6 text-gray-700 max-h-[60vh] overflow-y-auto">
                <p class="mb-4">Este termo esclarece a finalidade da coleta de dados para o Censo Agropecuário – Município de Quixadá (2025), em conformidade com a Lei Geral de Proteção de Dados (LGPD).</p>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    <li><strong>Finalidade:</strong> As informações coletadas, incluindo dados pessoais e de produção, serão utilizadas exclusivamente para fins estatísticos, visando a elaboração de um panorama sobre a produção agropecuária no município.</li>
                    <li><strong>Proteção e Anonimato:</strong> Os dados pessoais são protegidos e não serão divulgados individualmente. A apresentação dos resultados ocorrerá de forma agregada, garantindo o sigilo e o anonimato dos participantes.</li>
                    <li><strong>Participação:</strong> A colaboração com o censo é voluntária e fundamental para o desenvolvimento de políticas públicas para o setor agropecuário local.</li>
                </ul>
                <p>A coleta de dados só deverá ser iniciada após o esclarecimento destes pontos ao entrevistado.</p>
            </div>
        </div>
    </div>

    <div id="confirm-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="confirm-title" class="text-xl font-bold mb-4">Confirmar Ação</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Você tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- Service Worker and PWA Setup ---
        const registerServiceWorker = () => {
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'censo-agro-quixada-v3';
                    const urlsToCache = [
                        '.',
                        'https://cdn.tailwindcss.com',
                        'https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0'
                    ];
                    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache))));
                    self.addEventListener('fetch', e => {
                        if (e.request.method !== 'GET') return;
                        e.respondWith(caches.open(CACHE_NAME).then(c => c.match(e.request).then(r => r || fetch(e.request).then(res => {c.put(e.request, res.clone()); return res;}))));
                    });
                    self.addEventListener('activate', e => e.waitUntil(caches.keys().then(n => Promise.all(n.map(c => c !== CACHE_NAME && caches.delete(c))))));
                `;
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('SW registration successful:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            }
        };

        const generateIcon = (size) => {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#166534'; // Cor verde principal da aplicação
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = `bold ${size * 0.6}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('C', size / 2, size / 2 + size * 0.04);
            return canvas.toDataURL('image/png');
        };

        const setupPWA = () => {
            const manifest = {
                "name": "Censo Agropecuário 2025",
                "short_name": "CensoAgro",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f1f5f9", // Cor de fundo da aplicação (bg-gray-100)
                "theme_color": "#166534", // Cor verde principal da aplicação
                "description": "Censo Agropecuário – Município de Quixadá (2025)",
                "icons": [
                    { "src": generateIcon(192), "sizes": "192x192", "type": "image/png" },
                    { "src": generateIcon(512), "sizes": "512x512", "type": "image/png" }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
            const appleIcon = document.createElement('link');
            appleIcon.rel = 'apple-touch-icon';
            appleIcon.href = generateIcon(192);
            document.head.appendChild(appleIcon);
        };

        let deferredPrompt;
        const installButton = document.getElementById('install-pwa-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', async (e) => {
            e.preventDefault();
            installButton.classList.add('hidden');
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
            }
            dropdownMenu.classList.add('hidden');
        });

        window.addEventListener('appinstalled', () => { deferredPrompt = null; });

        // --- Application Logic ---
        const STORAGE_KEY = 'censoQuixada2025_v2.1';
        let records = [];
        let onConfirmAction = null;

        const recordsListContainer = document.getElementById('records-list-container');
        const emptyState = document.getElementById('empty-state');
        const recordCounterBadge = document.getElementById('record-counter-badge');
        const modal = document.getElementById('form-modal');
        const form = document.getElementById('census-form');
        const modalTitle = document.getElementById('modal-title');
        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const aboutModal = document.getElementById('about-modal');
        const lgpdModal = document.getElementById('lgpd-modal');
        const dropdownMenu = document.getElementById('dropdown-menu');

        const normalizeText = (text) => {
            if (typeof text !== 'string') return text;
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };
        const loadRecords = () => { records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; };
        const saveRecords = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(records)); };
        const formatDate = (iso) => iso ? new Date(iso).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

        const renderRecords = () => {
            recordsListContainer.innerHTML = '';
            const hasRecords = records.length > 0;
            emptyState.classList.toggle('hidden', hasRecords);
            recordsListContainer.classList.toggle('hidden', !hasRecords);
            if (hasRecords) {
                [...records].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md p-4 mb-4 flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${record.nomeCompleto}</h3>
                            <p class="text-gray-600">${record.endereco || 'Endereço não informado'}</p>
                            <p class="text-sm text-gray-400 mt-1">Coleta: ${formatDate(record.date)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-btn p-3 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200" data-id="${record.id}" title="Editar"><span class="material-symbols-outlined">edit</span></button>
                            <button class="delete-btn p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200" data-id="${record.id}" title="Remover"><span class="material-symbols-outlined">delete</span></button>
                        </div>`;
                    recordsListContainer.appendChild(card);
                });
            }
            recordCounterBadge.textContent = records.length;
        };
        
        const openModal = (recordId = null) => {
            form.reset();
            document.querySelectorAll('.selectable-btn.active, .selectable-multi-btn.active').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('[id^="detalhes"], [id$="Outro"], [id$="Detalhes"]').forEach(el => el.classList.add('hidden'));
            if (recordId) {
                modalTitle.textContent = 'Editar Registro';
                form.elements['record-id'].value = recordId;
                const record = records.find(r => r.id == recordId);
                if (record) {
                    Object.keys(record).forEach(key => {
                        const element = form.elements[key];
                        if (element && (typeof element.value !== 'undefined' || element.type === 'checkbox')) {
                           if (element.type === 'hidden' && element.previousElementSibling?.classList.contains('selectable-buttons')) {
                                const valueToSet = record[key] === true ? 'Sim' : (record[key] === false ? 'Não' : '');
                                element.value = valueToSet;
                                element.previousElementSibling.querySelectorAll('.selectable-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.value === valueToSet));
                            } else if (element.type === 'checkbox') {
                                element.checked = record[key];
                            }
                            else { element.value = record[key]; }
                        }
                        const buttonGroup = document.querySelector(`.multi-selectable-buttons[data-group-name="${key}"]`);
                        const checkboxes = form.querySelectorAll(`input[name="${key}"]`);
                        if(buttonGroup && Array.isArray(record[key])) {
                            record[key].forEach(value => {
                                const btn = buttonGroup.querySelector(`[data-value="${normalizeText(value)}"]`);
                                if(btn) btn.click();
                            });
                        } else if (checkboxes.length > 0 && Array.isArray(record[key])) {
                             record[key].forEach(value => {
                                const chk = form.querySelector(`input[name="${key}"][value="${normalizeText(value)}"]`);
                                if(chk) { chk.checked = true; chk.dispatchEvent(new Event('change', { bubbles: true })); }
                            });
                        }
                    });
                    form.querySelector('#posseTerra').dispatchEvent(new Event('change'));
                }
            } else {
                modalTitle.textContent = 'Adicionar Novo Registro';
                form.elements['record-id'].value = '';
            }
            modal.classList.remove('hidden');
        };
        
        const openConfirmDialog = (title, message, onConfirm) => {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            onConfirmAction = onConfirm;
            confirmDialog.classList.remove('hidden');
        };

        const closeModalUI = (modalElement) => modalElement.classList.add('hidden');

        const handleFormSubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const recordId = formData.get('record-id');
            let recordData = {
                id: recordId || Date.now().toString(),
                date: recordId ? records.find(r => r.id == recordId).date : new Date().toISOString()
            };
            for (let [key, value] of formData.entries()) {
                if (key === 'record-id') continue;
                const normalizedValue = normalizeText(value);
                if (recordData[key]) {
                    if (!Array.isArray(recordData[key])) recordData[key] = [recordData[key]];
                    recordData[key].push(normalizedValue);
                } else {
                    recordData[key] = normalizedValue;
                }
            }
            ['irrigadoMilho', 'irrigadoFeijao', 'irrigadoMandioca', 'energiaEletrica', 'possuiTrator', 'acessoCredito'].forEach(key => {
                const val = recordData[key];
                recordData[key] = val === 'Sim' ? true : (val === 'Nao' ? false : null);
            });
            document.querySelectorAll('.multi-selectable-buttons').forEach(group => {
                const groupName = group.dataset.groupName;
                recordData[groupName] = Array.from(group.querySelectorAll('.selectable-multi-btn.active')).map(btn => normalizeText(btn.dataset.value));
            });
            if (!recordData.atividadesAgricolas) recordData.atividadesAgricolas = [];
            recordData.lgpdConfirm = form.elements.lgpdConfirm.checked;
            if (recordId) {
                const index = records.findIndex(r => r.id == recordId);
                if (index !== -1) records[index] = { ...records[index], ...recordData };
            } else { records.push(recordData); }
            saveRecords();
            renderRecords();
            closeModalUI(modal);
        };

        const handleDeleteSingle = (recordId) => {
            openConfirmDialog('Confirmar Exclusão', 'Tem certeza que deseja apagar este registro? Esta ação não pode ser desfeita.', () => {
                records = records.filter(r => r.id != recordId);
                saveRecords();
                renderRecords();
                closeModalUI(confirmDialog);
            });
        };

        const handleDeleteAll = () => {
            openConfirmDialog('Remover todos', 'Tem certeza que deseja apagar TODOS os registros? Esta ação não pode ser desfeita.', () => {
                records = [];
                saveRecords();
                renderRecords();
                closeModalUI(confirmDialog);
            });
        };
        
        const triggerDownload = (blob, fileName) => {
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const handleExportCSV = async () => {
            if (records.length === 0) {
                alert('Não há registros para exportar.');
                return;
            }
            const sanitizeCell = (cell) => {
                if (cell === undefined || cell === null) return '';
                if (typeof cell === 'boolean') return cell ? 'True' : 'False';
                let cellStr = String(cell);
                if (cellStr.includes(',')) cellStr = `"${cellStr.replace(/"/g, '""')}"`;
                return cellStr;
            };
            const headers = [ 'id', 'date', 'nomeCompleto', 'cpf', 'telefone', 'endereco', 'latitude', 'longitude', 'areaTotal', 'areaProdutiva', 'posseTerra', 'posseTerraOutro', 'culturaMilho', 'areaMilho', 'irrigadoMilho', 'culturaFeijao', 'areaFeijao', 'irrigadoFeijao', 'culturaMandioca', 'areaMandioca', 'irrigadoMandioca', 'culturaHortalicas', 'especificarHortalicas', 'culturaFruticultura', 'especificarFruticultura', 'culturaOutro', 'especificarOutro', 'bovinos', 'caprinos', 'ovinos', 'suinos', 'outrasCriacoes', 'atividadeAgroindustria', 'atividadeTurismoRural', 'atividadeApicultura', 'atividadePiscicultura', 'outrasAtividadesDetalhes', 'fonteAguaPoco', 'fonteAguaAcude', 'fonteAguaCisterna', 'fonteAguaOutro', 'fonteAguaOutro', 'energiaEletrica', 'transporte', 'possuiTrator', 'outrosEquipamentos', 'trabalhadoresFamiliares', 'trabalhadoresTemporarios', 'trabalhadoresPermanentes', 'destinoConsumoProprio', 'destinoVendaLocal', 'destinoFeira', 'destinoCooperativa', 'destinoOutro', 'destinoProducaoOutro', 'acessoCredito', 'programaPNAE', 'programaPAA', 'programaPRONAF', 'programaOutro', 'programasGovernoOutro', 'desafioAgua', 'desafioInfraestrutura', 'desafioCredito', 'desafioMercado', 'desafioAssistenciaTecnica', 'desafioOutro', 'desafiosOutro', 'observacoes', 'lgpdConfirm' ];
            const csvRows = records.map(record => {
                const row = { id: record.id, date: record.date, nomeCompleto: record.nomeCompleto, cpf: record.cpf, telefone: record.telefone, endereco: record.endereco, latitude: record.latitude, longitude: record.longitude, areaTotal: record.areaTotal, areaProdutiva: record.areaProdutiva, posseTerra: record.posseTerra, posseTerraOutro: record.posseTerraOutro, culturaMilho: record.atividadesAgricolas?.includes('Milho'), areaMilho: record.areaMilho, irrigadoMilho: record.irrigadoMilho, culturaFeijao: record.atividadesAgricolas?.includes('Feijao'), areaFeijao: record.areaFeijao, irrigadoFeijao: record.irrigadoFeijao, culturaMandioca: record.atividadesAgricolas?.includes('Mandioca'), areaMandioca: record.areaMandioca, irrigadoMandioca: record.irrigadoMandioca, culturaHortalicas: record.atividadesAgricolas?.includes('Hortalicas'), especificarHortalicas: record.especificarHortalicas, culturaFruticultura: record.atividadesAgricolas?.includes('Fruticultura'), especificarFruticultura: record.especificarFruticultura, culturaOutro: record.atividadesAgricolas?.includes('Outro'), especificarOutro: record.especificarOutro, bovinos: record.bovinos, caprinos: record.caprinos, ovinos: record.ovinos, suinos: record.suinos, outrasCriacoes: record.outrasCriacoes, atividadeAgroindustria: record.outrasAtividades?.includes('Agroindustria'), atividadeTurismoRural: record.outrasAtividades?.includes('Turismo Rural'), atividadeApicultura: record.outrasAtividades?.includes('Apicultura'), atividadePiscicultura: record.outrasAtividades?.includes('Piscicultura'), outrasAtividadesDetalhes: record.outrasAtividadesDetalhes, fonteAguaPoco: record.fonteAgua?.includes('Poco'), fonteAguaAcude: record.fonteAgua?.includes('Acude'), fonteAguaCisterna: record.fonteAgua?.includes('Cisterna'), fonteAguaOutro: record.fonteAgua?.includes('Outro'), fonteAguaOutro: record.fonteAguaOutro, energiaEletrica: record.energiaEletrica, transporte: record.transporte, possuiTrator: record.possuiTrator, outrosEquipamentos: record.outrosEquipamentos, trabalhadoresFamiliares: record.trabalhadoresFamiliares, trabalhadoresTemporarios: record.trabalhadoresTemporarios, trabalhadoresPermanentes: record.trabalhadoresPermanentes, destinoConsumoProprio: record.destinoProducao?.includes('Consumo proprio'), destinoVendaLocal: record.destinoProducao?.includes('Venda local'), destinoFeira: record.destinoProducao?.includes('Feira'), destinoCooperativa: record.destinoProducao?.includes('Cooperativa'), destinoOutro: record.destinoProducao?.includes('Outro'), destinoProducaoOutro: record.destinoProducaoOutro, acessoCredito: record.acessoCredito, programaPNAE: record.programasGoverno?.includes('PNAE'), programaPAA: record.programasGoverno?.includes('PAA'), programaPRONAF: record.programasGoverno?.includes('PRONAF'), programaOutro: record.programasGoverno?.includes('Outro'), programasGovernoOutro: record.programasGovernoOutro, desafioAgua: record.desafios?.includes('Agua'), desafioInfraestrutura: record.desafios?.includes('Infraestrutura'), desafioCredito: record.desafios?.includes('Credito'), desafioMercado: record.desafios?.includes('Mercado'), desafioAssistenciaTecnica: record.desafios?.includes('Assistencia tecnica'), desafioOutro: record.desafios?.includes('Outro'), desafiosOutro: record.desafiosOutro, observacoes: record.observacoes, lgpdConfirm: record.lgpdConfirm };
                return headers.map(header => sanitizeCell(row[header])).join(',');
            });
            const csvContent = [headers.join(','), ...csvRows].join('\n');
            const fileName = `censo_agropecuario_${new Date().toISOString().split('T')[0]}.csv`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            try {
                const file = new File([blob], fileName, { type: 'text/csv' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Dados do Censo Agropecuário', text: `Arquivo de dados do censo: ${fileName}` });
                } else { triggerDownload(blob, fileName); }
            } catch (error) {
                console.error('Erro ao compartilhar:', error);
                alert(`Ocorreu um erro ao tentar compartilhar. O download será iniciado como alternativa.`);
                triggerDownload(blob, fileName);
            }
        };
        
        const handleGetCoords = () => {
            if (!navigator.geolocation) { alert("Geolocalização não é suportada pelo seu navegador."); return; }
            const btn = document.getElementById('get-coords-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined animate-spin">progress_activity</span> Obtendo...`;
            btn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    form.latitude.value = pos.coords.latitude.toFixed(6);
                    form.longitude.value = pos.coords.longitude.toFixed(6);
                    btn.innerHTML = originalHTML; btn.disabled = false;
                },
                (err) => {
                    let message = "Ocorreu um erro ao obter a localização.";
                    if (err.code === 1) message = "Permissão de localização negada. Por favor, habilite a permissão nas configurações do seu navegador/celular.";
                    if (err.code === 2) message = "Não foi possível determinar a sua localização (sinal de GPS fraco).";
                    alert(message);
                    btn.innerHTML = originalHTML; btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        const applyMask = (e, maskFn) => { e.target.value = maskFn(e.target.value); };
        const cpfMask = (v) => v.replace(/\D/g, '').slice(0, 11).replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{2})$/, '$1-$2');
        const phoneMask = (v) => {
            v = v.replace(/\D/g, '').slice(0, 11);
            if (v.length > 10) return v.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
            if (v.length > 5) return v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            if (v.length > 2) return v.replace(/^(\d\d)(\d{0,5}).*/, "($1) $2");
            return v.replace(/^(\d*)/, "($1");
        };

        const setupEventListeners = () => {
            document.getElementById('add-new-btn').addEventListener('click', () => openModal());
            document.getElementById('cancel-btn').addEventListener('click', () => closeModalUI(modal));
            document.getElementById('export-csv-btn').addEventListener('click', handleExportCSV);
            document.getElementById('get-coords-btn').addEventListener('click', handleGetCoords);
            form.addEventListener('submit', handleFormSubmit);
            document.getElementById('cpf').addEventListener('input', (e) => applyMask(e, cpfMask));
            document.getElementById('telefone').addEventListener('input', (e) => applyMask(e, phoneMask));
            document.getElementById('posseTerra').addEventListener('change', (e) => {
                document.getElementById('posseTerraOutro').classList.toggle('hidden', e.target.value !== 'Outro');
            });
            recordsListContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) openModal(editBtn.dataset.id);
                if (deleteBtn) handleDeleteSingle(deleteBtn.dataset.id);
            });
            document.getElementById('record-counter-btn').addEventListener('click', () => dropdownMenu.classList.toggle('hidden'));
            document.getElementById('delete-all-btn').addEventListener('click', (e) => { e.preventDefault(); handleDeleteAll(); dropdownMenu.classList.add('hidden'); });
            document.getElementById('about-btn').addEventListener('click', (e) => { e.preventDefault(); aboutModal.classList.remove('hidden'); dropdownMenu.classList.add('hidden'); });
            document.getElementById('close-about-btn').addEventListener('click', () => closeModalUI(aboutModal));
            window.addEventListener('click', (e) => { if (!document.getElementById('menu-wrapper').contains(e.target)) dropdownMenu.classList.add('hidden'); });
            document.getElementById('lgpd-info-btn').addEventListener('click', () => lgpdModal.classList.remove('hidden'));
            document.getElementById('close-lgpd-btn').addEventListener('click', () => closeModalUI(lgpdModal));
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModalUI(confirmDialog));
            document.getElementById('confirm-action-btn').addEventListener('click', () => { if (onConfirmAction) onConfirmAction(); });
            form.addEventListener('click', (e) => {
                const singleBtn = e.target.closest('.selectable-btn');
                if (singleBtn) {
                    const group = singleBtn.parentElement;
                    const targetInput = document.getElementById(group.dataset.targetInput);
                    targetInput.value = targetInput.value === singleBtn.dataset.value ? '' : singleBtn.dataset.value;
                    group.querySelectorAll('.selectable-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.value === targetInput.value));
                }
                const multiBtn = e.target.closest('.selectable-multi-btn');
                if (multiBtn) {
                    multiBtn.classList.toggle('active');
                    const groupName = multiBtn.parentElement.dataset.groupName;
                    const outroInput = document.getElementById(`${groupName}Outro`);
                    if (outroInput) outroInput.classList.toggle('hidden', !multiBtn.parentElement.querySelector('[data-value="Outro"].active'));
                    const detailsInput = document.getElementById(`${groupName}Detalhes`);
                    if (detailsInput) {
                        const shouldShowDetails = Array.from(multiBtn.parentElement.querySelectorAll('.active[data-triggers-details="true"]')).length > 0;
                        detailsInput.classList.toggle('hidden', !shouldShowDetails);
                    }
                }
            });
            form.addEventListener('change', (e) => {
                const checkbox = e.target.closest('input[type="checkbox"][data-details]');
                if(checkbox) document.getElementById(checkbox.dataset.details).classList.toggle('hidden', !checkbox.checked);
            });
        };

        // --- Initialization ---
        const init = () => {
            loadRecords();
            renderRecords();
            setupEventListeners();
            setupPWA();
            registerServiceWorker();
        };

        init();
    });
    </script>
</body>
</html>
