<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');

        /* Custom animation for loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }

        /* Custom styles for winner banner */
        .winner-banner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 8px 16px;
            font-weight: 900;
            font-size: 1.8rem;
            border-radius: 8px;
            text-transform: uppercase;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        /* Styling for the card grid numbers */
        .bingo-card-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        .bingo-card-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .bingo-card-cell.marked {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 700;
        }
        .bingo-card-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            border-radius: 4px;
        }
        .bingo-card-header .letter {
            font-size: 1.25rem;
        }
        .bingo-card-header .range {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 95vw;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-0 left-0 right-0 z-50 p-4 pointer-events-none flex justify-center"></div>

    <div id="app" class="container mx-auto p-4 max-w-7xl pb-24">
        <!-- Header -->
        <header class="bg-white p-6 rounded-xl shadow-md mb-6">
            <div class="flex items-center space-x-4">
                <div class="bg-blue-500 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl font-bold shadow-inner">
                    B
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-800">
                        Bingo Pro<sup class="text-sm font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-md -top-5 relative ml-1">beta</sup>
                    </h1>
                    <p class="text-gray-500">O seu gestor de cartelas de bingo offline.</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Sorteio Section -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Sorteio</h2>
                    <form id="draw-form" class="flex items-center gap-2 mb-4">
                        <input type="number" id="drawn-number-input" placeholder="Nº Sorteado" min="1" max="75" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <button type="submit" class="bg-blue-500 text-white font-semibold py-3 px-5 rounded-lg hover:bg-blue-600 transition shadow">Adicionar</button>
                    </form>
                    
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">Números sorteados (<span id="drawn-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <button id="sort-drawn-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                                <i class="fa-solid fa-arrow-up-wide-short"></i>
                                <span id="sort-order-text">Crescente</span>
                            </button>
                            <button id="clear-drawn-btn" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600 transition text-sm shadow">Limpar</button>
                        </div>
                    </div>

                    <div id="drawn-numbers-list" class="flex flex-wrap justify-start gap-2 bg-gray-100 p-3 rounded-lg min-h-[50px]">
                        <!-- Drawn numbers will be injected here -->
                    </div>
                </div>

                <!-- Card Controls Section -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Cartelas</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="add-card-btn" class="bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition shadow flex items-center justify-center gap-2"><i class="fa-solid fa-plus-circle"></i> Adicionar</button>
                        <button id="import-btn" class="bg-purple-500 text-white font-bold py-3 rounded-lg hover:bg-purple-600 transition shadow flex items-center justify-center gap-2"><i class="fa-solid fa-upload"></i> Importar</button>
                        <button id="export-btn" class="bg-indigo-500 text-white font-bold py-3 rounded-lg hover:bg-indigo-600 transition shadow flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> Exportar</button>
                        <button id="config-btn" class="bg-gray-500 text-white font-bold py-3 rounded-lg hover:bg-gray-600 transition shadow flex items-center justify-center gap-2"><i class="fa-solid fa-gear"></i> Configurar</button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2">
                <div class="flex justify-end mb-4">
                    <div class="flex items-center gap-2">
                        <label for="sort-cards-by" class="font-medium text-gray-600">Ordenar cartelas por:</label>
                        <select id="sort-cards-by" class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                            <option value="marked">Mais marcadas</option>
                            <option value="alpha">Ordem alfabética</option>
                        </select>
                    </div>
                </div>
                <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Cards will be injected here -->
                </div>
                 <div id="no-cards-message" class="hidden text-center bg-white p-10 rounded-xl shadow-md">
                    <i class="fa-solid fa-clone text-5xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-700">Nenhuma cartela registrada</h3>
                    <p class="text-gray-500 mt-2">Use o botão "Adicionar" para começar a gerenciar suas cartelas de bingo.</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer id="footer" class="text-center mt-8">
            <button id="delete-all-cards-btn" class="hidden bg-transparent border-2 border-red-500 text-red-500 font-bold py-3 px-6 rounded-lg hover:bg-red-500 hover:text-white transition shadow-sm">
                <i class="fa-solid fa-trash-alt"></i> Apagar todas as cartelas
            </button>
        </footer>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- Hidden file inputs -->
    <input type="file" id="import-file-input" class="hidden" accept=".json">
    <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment">

    <!-- JavaScript -->
    <script type="module">
        // --- Gemini API Configuration ---
        const GEMINI_API_KEY = ""; // Provided by the environment

        // --- Application State ---
        let state = {
            drawnNumbers: [],
            cards: [],
            settings: {
                winCondition: 'full', // 'full' or 'corners'
                sortDrawn: 'asc', // 'asc' or 'desc'
                sortCards: 'marked', // 'marked' or 'alpha'
            }
        };

        // --- Interaction State ---
        let lastCardTap = 0;
        let lastDrawnTap = 0;

        // --- DOM Elements ---
        const dom = {
            app: document.getElementById('app'),
            notificationContainer: document.getElementById('notification-container'),
            drawForm: document.getElementById('draw-form'),
            drawnNumberInput: document.getElementById('drawn-number-input'),
            drawnCount: document.getElementById('drawn-count'),
            drawnNumbersList: document.getElementById('drawn-numbers-list'),
            sortDrawnBtn: document.getElementById('sort-drawn-btn'),
            sortOrderText: document.getElementById('sort-order-text'),
            clearDrawnBtn: document.getElementById('clear-drawn-btn'),
            addCardBtn: document.getElementById('add-card-btn'),
            importBtn: document.getElementById('import-btn'),
            exportBtn: document.getElementById('export-btn'),
            configBtn: document.getElementById('config-btn'),
            sortCardsBy: document.getElementById('sort-cards-by'),
            cardsContainer: document.getElementById('cards-container'),
            noCardsMessage: document.getElementById('no-cards-message'),
            footer: document.getElementById('footer'),
            deleteAllCardsBtn: document.getElementById('delete-all-cards-btn'),
            modalContainer: document.getElementById('modal-container'),
            importFileInput: document.getElementById('import-file-input'),
            cameraInput: document.getElementById('camera-input'),
        };

        // --- Constants ---
        const BINGO_COLS = {
            'B': { min: 1, max: 15 },
            'I': { min: 16, max: 30 },
            'N': { min: 31, max: 45 },
            'G': { min: 46, max: 60 },
            'O': { min: 61, max: 75 },
        };
        const BINGO_LETTERS = ['B', 'I', 'N', 'G', 'O'];

        // --- State Management ---
        const saveState = () => {
            try {
                localStorage.setItem('bingoProState', JSON.stringify(state));
            } catch (error) {
                console.error("Erro ao salvar o estado:", error);
                showNotification("Erro ao salvar dados. O armazenamento pode estar cheio.", 'error');
            }
        };

        const loadState = () => {
            const savedState = localStorage.getItem('bingoProState');
            if (savedState) {
                state = JSON.parse(savedState);
            } else {
                // Initialize with a clean state, no sample cards.
                // The default state object is already clean.
                // We just need to save it to establish the localStorage item.
                saveState();
            }
        };

        // --- Rendering ---
        const render = () => {
            renderDrawnNumbers();
            renderCards();
            updateControls();
        };

        const renderDrawnNumbers = () => {
            dom.drawnNumbersList.innerHTML = '';
            dom.drawnCount.textContent = state.drawnNumbers.length;

            const sortedNumbers = [...state.drawnNumbers].sort((a, b) => {
                return state.settings.sortDrawn === 'asc' ? a - b : b - a;
            });

            if (sortedNumbers.length === 0) {
                dom.drawnNumbersList.innerHTML = `<p class="text-center text-gray-500 text-sm">Nenhum número sorteado ainda.</p>`;
            } else {
                sortedNumbers.forEach(num => {
                    const letter = getBingoLetter(num);
                    const el = document.createElement('div');
                    el.className = 'bg-white shadow-sm rounded-full w-12 h-12 flex flex-col items-center justify-center font-bold text-gray-700 cursor-pointer hover:bg-red-100 transition';
                    el.innerHTML = `<div class="text-blue-600 text-xs">${letter}</div><div class="text-lg leading-tight">${num}</div>`;
                    el.dataset.number = num;
                    
                    // Double tap/click to remove
                    el.addEventListener('dblclick', () => confirmRemoveDrawnNumber(num));
                    el.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        const currentTime = new Date().getTime();
                        const tapLength = currentTime - lastDrawnTap;
                        if (tapLength < 300 && tapLength > 0) {
                            confirmRemoveDrawnNumber(num);
                        }
                        lastDrawnTap = currentTime;
                    });
                    dom.drawnNumbersList.appendChild(el);
                });
            }
        };

        const renderCards = () => {
            dom.cardsContainer.innerHTML = '';
            
            const sortedCards = sortCards([...state.cards]);

            if (sortedCards.length === 0) {
                dom.noCardsMessage.classList.remove('hidden');
                dom.deleteAllCardsBtn.classList.add('hidden');
            } else {
                dom.noCardsMessage.classList.add('hidden');
                dom.deleteAllCardsBtn.classList.remove('hidden');
                sortedCards.forEach(card => {
                    const cardEl = createCardElement(card);
                    dom.cardsContainer.appendChild(cardEl);
                });
            }
        };
        
        const createCardElement = (card) => {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'bg-white p-4 rounded-xl shadow-md relative overflow-hidden transition-all duration-300';
            
            const markedCount = countMarkedNumbers(card);
            const isWinner = checkWin(card);

            if (isWinner) {
                cardWrapper.classList.add('border-4', 'border-yellow-400', 'shadow-2xl');
                const banner = document.createElement('div');
                banner.className = 'winner-banner';
                banner.textContent = 'BINGO!';
                cardWrapper.appendChild(banner);
            }

            let cardHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-xl font-bold truncate pr-16">${card.name}</h3>
                        <p class="text-sm text-gray-500">${markedCount} / 24 números marcados</p>
                    </div>
                    <div class="absolute top-4 right-4 flex space-x-2">
                        <button class="edit-card-btn text-gray-500 hover:text-blue-600" data-id="${card.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-card-btn text-gray-500 hover:text-red-600" data-id="${card.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                <div class="bingo-card-grid">
            `;

            // Headers B-I-N-G-O
            BINGO_LETTERS.forEach(letter => {
                cardHTML += `
                    <div class="bingo-card-header bg-blue-500">
                        <span class="letter">${letter}</span>
                        <span class="range">${BINGO_COLS[letter].min}-${BINGO_COLS[letter].max}</span>
                    </div>
                `;
            });

            // Numbers
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const number = card.grid[col][row]; // Transposing for correct render
                    const isMarked = number === '⭐️' || state.drawnNumbers.includes(number);
                    const cellClass = isMarked ? 'marked' : 'bg-gray-100 hover:bg-gray-200';
                    cardHTML += `<div class="bingo-card-cell ${cellClass}" data-number="${number}" data-card-id="${card.id}">${number}</div>`;
                }
            }

            cardHTML += `</div>`;
            cardWrapper.innerHTML += cardHTML;
            return cardWrapper;
        };

        const updateControls = () => {
            // Update sort dropdowns
            dom.sortCardsBy.value = state.settings.sortCards;
            dom.sortOrderText.textContent = state.settings.sortDrawn === 'asc' ? 'Crescente' : 'Recente';
            
            // Enable/disable export button
            if (state.cards.length === 0 && state.drawnNumbers.length === 0) {
                dom.exportBtn.disabled = true;
                dom.exportBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                dom.exportBtn.disabled = false;
                dom.exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        // --- Logic & Event Handlers ---
        const handleDrawFormSubmit = (e) => {
            e.preventDefault();
            const num = parseInt(dom.drawnNumberInput.value);
            if (!num || num < 1 || num > 75) {
                showNotification("Por favor, insira um número válido entre 1 e 75.", 'error');
                return;
            }
            if (state.drawnNumbers.includes(num)) {
                showNotification(`O número ${num} já foi sorteado.`, 'warning');
                dom.drawnNumberInput.value = '';
                dom.drawnNumberInput.focus();
                return;
            }
            addDrawnNumber(num);
            dom.drawnNumberInput.value = '';
            dom.drawnNumberInput.focus();
        };

        const addDrawnNumber = (num, showMsg = true) => {
            if (!state.drawnNumbers.includes(num)) {
                state.drawnNumbers.push(num);
                saveState();
                render();
                if (showMsg) {
                    showNotification(`Número ${num} adicionado!`, 'success');
                }
            }
        };

        const removeDrawnNumber = (num) => {
            state.drawnNumbers = state.drawnNumbers.filter(n => n !== num);
            saveState();
            render();
            showNotification(`Número ${num} removido.`, 'warning');
      
